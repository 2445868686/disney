<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¸Šæµ·è¿ªå£«å°¼ Â· ä¸€æ—¥æ¸¸å¯äº¤äº’æ”»ç•¥å¡ç‰‡</title>
<link rel="preconnect" href="https://unpkg.com"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-9Ps0e2M1G7b8Q2kO9x1n+G6s+5jWvVwI3pSBu/7pJr3gKX2l0Wk7uX3nV6i9lCDj" crossorigin="anonymous">
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-q8T5kE1J3z2rVv9g6W3Qk7m8M2cYkqj2V8l1m0H6x1F8Hj3bqK3wY7k2Z1pU8b8Q" crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#0b1220;            /* æ·±è‰²èƒŒæ™¯ */
    --card:#111827;          /* å¡ç‰‡åº•è‰² */
    --muted:#9ca3af;         /* æ¬¡çº§æ–‡å­— */
    --accent:#60a5fa;        /* ä¸»é¢˜è“ */
    --accent-2:#34d399;      /* æˆåŠŸç»¿ */
    --accent-3:#f59e0b;      /* æç¤ºæ©™ */
    --danger:#f87171;        /* çº¢ */
    --ring: 0 0 0 2px rgba(96,165,250,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0e172a 65%);color:#e5e7eb;font:14px/1.55 system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans CJK SC, "Microsoft YaHei", sans-serif}
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 120px}
  header{
    position:sticky;top:0;z-index:50;background:rgba(11,18,32,.8);backdrop-filter:blur(8px);border-bottom:1px solid #111827;
  }
  .head-bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .head-title{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 220deg,#60a5fa,#34d399);box-shadow:0 0 40px rgba(96,165,250,.3)}
  h1{margin:0;font-size:18px;font-weight:700}
  .head-actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{box-shadow:var(--ring)}
  .btn.primary{background:linear-gradient(180deg,#1f4fff,#1b72ff);border-color:#1e40af}
  .btn.ghost{background:transparent}
  .layout{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:16px}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .card h2{margin:0 0 8px;padding:0 0 4px;border-bottom:1px dashed #1f2937;color:#fff;font-size:16px}
  .card .inner{padding:16px}
  .muted{color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #1f2937;border-radius:999px;padding:6px 10px}
  .chip.badge{background:#0b1220;font-weight:700;color:#cbd5e1}
  .chip.ok{background:rgba(52,211,153,.12);border-color:#14532d;color:#86efac}
  .chip.warn{background:rgba(245,158,11,.1);border-color:#7c2d12;color:#fbbf24}
  .chip.danger{background:rgba(248,113,113,.1);border-color:#7f1d1d;color:#fecaca}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{display:flex;gap:10px;align-items:flex-start;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .item input[type="checkbox"]{width:18px;height:18px;margin-top:3px}
  .item .grow{flex:1}
  .item .note{color:#9ca3af;font-size:12px}
  .search{display:flex;gap:8px;margin-bottom:8px}
  .search input{flex:1;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;padding:10px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{padding:8px 10px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;cursor:pointer}
  .tab.active{background:rgba(96,165,250,.15);border-color:#2563eb;color:#bfdbfe}
  .timeline{display:flex;flex-direction:column;gap:12px}
  .step{border:1px solid #1f2937;border-radius:14px;overflow:hidden}
  .step-head{display:flex;align-items:center;gap:10px;background:#0b1220;padding:10px;border-bottom:1px solid #1f2937}
  .step-num{width:26px;height:26px;border-radius:7px;background:linear-gradient(180deg,#60a5fa,#34d399);color:#0b1220;font-weight:800;display:grid;place-items:center}
  .step-title{font-weight:700}
  .step-tags{margin-left:auto;display:flex;gap:6px}
  .step-body{padding:10px;display:none}
  .step.open .step-body{display:block}
  .step .detail{color:#cbd5e1}
  .stamp{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(52,211,153,.1);border:1px solid #14532d;color:#86efac}
  .optional{opacity:.9}
  .counter{font-variant-numeric:tabular-nums}
  .map{height:420px;border-radius:14px;overflow:hidden;border:1px solid #1f2937}
  .map-fallback{display:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}
  footer{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:60}
  footer .btn{box-shadow:0 8px 20px rgba(0,0,0,.35)}
</style>
</head>
<body>
  <header>
    <div class="head-bar wrap" style="padding:12px 0">
      <div class="head-title">
        <div class="logo" aria-hidden></div>
        <div>
          <h1>ä¸Šæµ·è¿ªå£«å°¼ Â· ä¸€æ—¥æ¸¸å¯äº¤äº’æ”»ç•¥å¡ç‰‡</h1>
          <div class="muted" id="todayInfo">ä»Šå¤© Â· â€”</div>
        </div>
      </div>
      <div class="head-actions">
        <button class="btn" id="btnExport">å¯¼å‡ºä»Šæ—¥è¿›åº¦</button>
        <button class="btn ghost" id="btnReset">æ¸…ç©ºå‹¾é€‰</button>
        <button class="btn primary" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
      </div>
    </div>
  </header>

  <main class="wrap layout">
    <!-- å·¦åˆ—ï¼šä¿¡æ¯å¡ç‰‡ -->
    <section class="stack" style="display:flex;flex-direction:column;gap:16px">

      <!-- å®‰æ£€ä¸å…¥å›­ -->
      <article class="card">
        <div class="inner">
          <h2>â‘  å®‰æ£€ & å…¥å›­</h2>
          <div class="chips" style="margin-bottom:10px">
            <span class="chip badge">å»ºè®® 6:10 ç¬¬ä¸€é“é—¨ï¼ˆé å·¦ï¼‰</span>
            <span class="chip badge">7:10 ç¬¬äºŒé“é—¨å…¥å›­å†²åˆº</span>
          </div>
          <div class="list">
            <label class="item"><input type="checkbox" data-key="gate-middle"/> <div class="grow"><b>å®‰æ£€é€šé“</b>ï¼šä¼˜å…ˆèµ°<b>ä¸­é—´ä¸¤æ¡</b>ï¼ˆå°¤å…¶<b>å€’æ•°ç¬¬äºŒä¸ª</b>ï¼‰ã€‚<div class="note">é”™å³°æ’é˜Ÿï¼Œæ£€æŸ¥åŒ…é€Ÿè¿‡ã€‚</div></div></label>
            <label class="item"><input type="checkbox" data-key="gate-9-10-11"/> <div class="grow"><b>æ£€ç¥¨å£</b>ï¼šä¼˜å…ˆ <b>9 / 10 / 11</b> å·é—¸æœºã€‚</div></label>
            <label class="item"><input type="checkbox" data-key="610-line1"/> <div class="grow"><b>6:10</b> åˆ°è¾¾<b>ç¬¬ä¸€é“é—¨ï¼ˆå·¦è¾¹ï¼‰</b>æ’é˜Ÿã€‚</div></label>
            <label class="item"><input type="checkbox" data-key="710-sprint"/> <div class="grow"><b>7:10</b> ç¬¬äºŒé“é—¨å¼€ <b>å…¥å›­å†²åˆº</b>ã€‚</div></label>
          </div>
        </div>
      </article>

      <!-- äº¤é€š -->
      <article class="card">
        <div class="inner">
          <h2>â‘¡ äº¤é€š</h2>
          <div class="list">
            <label class="item"><input type="checkbox" data-key="gate-1-walk"/> <div class="grow">ä»<b>1å·å£</b>æ­¥è¡Œçº¦<b>5 åˆ†é’Ÿ</b>åˆ°å›­åŒºã€‚</div></label>
            <label class="item"><input type="checkbox" data-key="gate-3-taxi"/> <div class="grow">æ‰“è½¦è‡³<b>3å·å£</b> / å‡ºç§Ÿè½¦ä¸‹å®¢åŒºæ›´è¿‘ã€‚</div></label>
            <div class="item">
              <div class="grow">
                <div class="chips">
                  <span class="chip warn">åœ°é“ï¼š<b>11å·çº¿ Â· è¿ªå£«å°¼ç«™</b></span>
                  <a class="chip" target="_blank" rel="noopener" href="https://www.openstreetmap.org/?mlat=31.143429&mlon=121.663737#map=17/31.14343/121.66374">æ‰“å¼€åœ¨çº¿åœ°å›¾</a>
                </div>
                <div class="note">å‡ºç«™æ­¥è¡Œå¯è¾¾æ˜Ÿæ„¿æ¹–ä¸å…¥å›­å£ã€‚</div>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- å¿…å¸¦æ¸…å• -->
      <article class="card">
        <div class="inner">
          <h2>â‘¢ å¿…å¸¦æ¸…å•</h2>
          <div class="grid" id="packing"></div>
        </div>
      </article>

      <!-- é¢„çº¦ & è§é¢ä¼š -->
      <article class="card">
        <div class="inner">
          <h2>â‘£ é¢„çº¦ & è§é¢ä¼š</h2>
          <div class="list">
            <label class="item"><input type="checkbox" data-key="book-storybook"/> <div class="grow"><b>ç±³å¥‡å¦™æ¸¸ç«¥è¯ä¹¦</b>ï¼ˆAPPé¢„çº¦ç­‰å€™å¡ï¼‰ï¼šå…¥å›­å³ä¾§æ’é˜Ÿï¼Œ<b>ä¸€æ¥¼é˜¶æ¢¯ä¸­åæ’</b>æ›´ç¨³ã€‚</div></label>
            <label class="item"><input type="checkbox" data-key="zootopia-meet"/> <div class="grow"><b>åŠ¨ç‰©åŸè­¦å±€æ‹›å‹Ÿä¸­å¿ƒ</b>ï¼š<b>æœ±è¿ª/å°¼å…‹</b>è§é¢ä¼šï¼ˆæ—è¾¹å¯ç›–ç« ï¼‰ã€‚</div></label>
            <label class="item"><input type="checkbox" data-key="garden-meet"/> <div class="grow"><b>å¥‡æƒ³èŠ±å›­</b>è§é¢ä¼šï¼šç•™æ„å½“å¤©æ—¶åˆ»è¡¨ã€‚</div></label>
            <div class="item"><div class="grow">
              <b>æ—¶é—´å¡</b>ï¼š<span class="chip">16:25</span> <span class="chip">17:30</span>ï¼ˆ<b>ç±³å¥‡å¦™æ¸¸ç«¥è¯ä¹¦</b>ï¼‰
              <div class="note">å»ºè®®æå‰ 15 åˆ†é’Ÿåˆ°è¾¾æ’é˜Ÿç‚¹ã€‚</div>
            </div></div>
          </div>
        </div>
      </article>

      <!-- ç›–ç« æ¸…å• -->
      <article class="card">
        <div class="inner">
          <h2>â‘¤ ç›–ç« æ¸…å• <span class="muted">(<span id="stampDone" class="counter">0</span>/<span id="stampTotal" class="counter">0</span>)</span></h2>
          <div class="search"><input id="stampSearch" placeholder="æœç´¢ç›–ç« ç‚¹â€¦ï¼ˆå¦‚ï¼šè€è½¦ç«™ / ç±³å¥‡ï¼‰"/></div>
          <div id="stamps" class="list"></div>
        </div>
      </article>
    </section>

    <!-- å³åˆ—ï¼šåœ°å›¾ + è¡Œç¨‹ -->
    <section style="display:flex;flex-direction:column;gap:16px">
      <article class="card">
        <div class="inner">
          <h2>åœ¨çº¿åœ°å›¾ï¼ˆå¯ç¼©æ”¾/ç‚¹å‡»ï¼‰</h2>
          <div id="map" class="map" role="region" aria-label="ä¸Šæµ·è¿ªå£«å°¼åœ¨çº¿åœ°å›¾"></div>
          <div id="mapFallback" class="map-fallback" aria-hidden>
            <img src="disney_map.png" alt="ä¸Šæµ·è¿ªå£«å°¼å¹³é¢å›¾ï¼ˆç¦»çº¿å ä½ï¼‰" style="width:100%;display:block"/>
          </div>
          <div class="chips" style="margin-top:8px">
            <a class="chip" target="_blank" rel="noopener" href="https://www.openstreetmap.org/?mlat=31.1440&mlon=121.6570#map=16/31.1440/121.6570">åœ¨ OpenStreetMap æ‰“å¼€</a>
            <a class="chip" target="_blank" rel="noopener" href="https://maps.apple.com/?q=Shanghai+Disneyland&sll=31.1440,121.6570">åœ¨ Apple åœ°å›¾æŸ¥çœ‹</a>
            <a class="chip" target="_blank" rel="noopener" href="https://maps.google.com/?q=31.1440,121.6570">åœ¨ Google åœ°å›¾æŸ¥çœ‹</a>
          </div>
        </div>
      </article>

      <!-- è¡Œç¨‹æ—¶é—´è½´ -->
      <article class="card">
        <div class="inner">
          <h2>â‘¥ ä¸€æ—¥æ¸¸æ—¶é—´è½´ï¼ˆä»æ—©åˆ°æ™š Â· å¯æŠ˜å ï¼‰</h2>
          <div class="tabs" id="filters">
            <button class="tab active" data-filter="all">å…¨éƒ¨</button>
            <button class="tab" data-filter="must">åªçœ‹å¿…ç©</button>
            <button class="tab" data-filter="opt">åªçœ‹å¯é€‰</button>
          </div>
          <div class="search"><input id="search" placeholder="æŒ‰é¡¹ç›® / å…³é”®è¯è¿‡æ»¤ï¼Œå¦‚ï¼šçŸ¿å±±è½¦ / å·¦ä¾§æ’é˜Ÿ / ç¬¬ä¸€æ’"/></div>
          <div id="timeline" class="timeline"></div>
        </div>
      </article>
    </section>
  </main>

  <footer>
    <button class="btn" id="btnExpand">å±•å¼€å…¨éƒ¨</button>
    <button class="btn" id="btnCollapse">æŠ˜å å…¨éƒ¨</button>
  </footer>

<script>
// ====== å·¥å…·å‡½æ•°ï¼šæœ¬åœ°å­˜å‚¨å¼€å…³ ======
const KEY_PREFIX = 'sd_interactive_v1.';
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function save(key, val){localStorage.setItem(KEY_PREFIX+key, JSON.stringify(val))}
function load(key, def){try{return JSON.parse(localStorage.getItem(KEY_PREFIX+key)) ?? def}catch{return def}}
function persistChecks(root){
  root.querySelectorAll('input[type="checkbox"]').forEach(el=>{
    const k = el.dataset.key; if(!k) return;
    el.checked = load(k,false);
    el.addEventListener('change', ()=> save(k, el.checked));
  });
}

// ====== å¤´éƒ¨ï¼šä»Šå¤©ä¿¡æ¯ ======
(function(){
  const now = new Date();
  const fmt = n=> n.toString().padStart(2,'0');
  $('#todayInfo').textContent = `${now.getFullYear()}-${fmt(now.getMonth()+1)}-${fmt(now.getDate())} Â· ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][now.getDay()]}`;
})();

// ====== å¿…å¸¦æ¸…å• ======
const PACK_ITEMS = [
  'èº«ä»½è¯','çº¸å·¾','æ¹¿çº¸å·¾','é›¨è¡£','å……ç”µå®','è½»ä¾¿é›¶é£Ÿ','åƒåœ¾è¢‹','æ°´æ¯','é™æ¸©æ¯›å·¾'
];
(function(){
  const box = $('#packing');
  PACK_ITEMS.forEach((name,i)=>{
    const key = 'pack.'+i;
    const el = document.createElement('label');
    el.className = 'item';
    el.innerHTML = `<input type="checkbox" data-key="${key}"/> <div class="grow"><b>${name}</b></div>`;
    box.appendChild(el);
  });
  persistChecks(box);
})();

// ====== ç›–ç« æ¸…å• ======
const STAMPS = [
  'åŠ¨ç‰©åŸè­¦å±€æ‹›å‹Ÿä¸­å¿ƒï¼ˆæœ±è¿ª/å°¼å…‹è§é¢ä¼šæ—ï¼‰',
  'èˆ¹å¥‡æˆæ°´æ»©å·¦ä¾§æ ‘æœ¨æ—',
  'å¤è¿¹æ¢ç´¢è¥å…¥å£',
  'å¥‡å¥‡è’‚è’‚æ·˜æ·˜é“ºï¼ˆåº—å†…ï¼‰',
  'åˆ›æé€Ÿå…‰è½®ï¼ˆå¤–ä¾§ï¼‰',
  'å·´æ–¯å…‰å¹´æ˜Ÿé™…è¥æ•‘ï¼ˆæ—è¾¹ï¼‰',
  'å¤ªç©ºå¯¹è¯å²è¿ªå¥‡ï¼ˆé™„è¿‘ï¼‰',
  'è‰¾å°”ç©å…·åº—ï¼ˆé—¨å£ï¼‰',
  'ç±³å¥‡ç±³å¦®åŒå¿ƒé“ºï¼ˆåº—å†…ï¼‰',
  'ç«¥è¯åŸå ¡ï¼ˆå¤–ä¾§ï¼‰',
  'æ£®æ—ç™¾ç‰©å•†åº—ï¼ˆæ”¶é“¶å°é™„è¿‘ï¼‰',
  'çˆ±ä¸½ä¸è¿·å®«å‡ºå£',
  'åäºŒæœ‹å‹å›­é ç‹—ç‹—å£ç”» Â· èŠ±é—´ç¾å‘³æ—',
  'è€è½¦ç«™å•†åº—ï¼ˆå‡ºå£å¤„ï¼‰',
  'M å¤§è¡—è´­ç‰©å»Šï¼ˆè¿›é—¨å³æ‰‹è¾¹ï¼‰',
  'ç«¥è½¦è½®æ¤…ç§Ÿèµå¤„'
];
(function(){
  const list = $('#stamps');
  STAMPS.forEach((name,i)=>{
    const key = 'stamp.'+i;
    const row = document.createElement('label');
    row.className = 'item';
    row.innerHTML = `<input type="checkbox" data-key="${key}"/> <div class="grow">${name}</div>`;
    list.appendChild(row);
  });
  const refresh = ()=>{
    const total = STAMPS.length;
    const done = STAMPS.filter((_,i)=> load('stamp.'+i,false)).length;
    $('#stampTotal').textContent = total; $('#stampDone').textContent = done;
  };
  list.addEventListener('change', refresh);
  persistChecks(list); refresh();
  // æœç´¢è¿‡æ»¤
  $('#stampSearch').addEventListener('input', e=>{
    const kw = e.target.value.trim();
    $$('#stamps .item').forEach((el,idx)=>{
      const show = !kw || STAMPS[idx].toLowerCase().includes(kw.toLowerCase());
      el.style.display = show ? '' : 'none';
    })
  });
})();

// ====== æ—¶é—´è½´ï¼ˆå¿…ç©/å¯é€‰ + å¯æŠ˜å ï¼‰ ======
const STEPS = [
  {n:1,  t:'å®‰æ£€ä¸æ£€ç¥¨å£',       must:true,  tip:'é€šé“é€‰ä¸­é—´ä¸¤æ¡ï¼ˆå°¤å…¶å€’æ•°ç¬¬äºŒä¸ªï¼‰ï¼›é¦–é€‰ 9/10/11 å·é—¸æœºã€‚', more:''},
  {n:2,  t:'äº¤é€šä¸å…¥å£é€‰æ‹©',     must:true,  tip:'1å·å£æ­¥è¡Œ 5 åˆ†é’Ÿï¼›æˆ–æ‰“è½¦è‡³ 3 å·å£/å‡ºç§Ÿè½¦ä¸‹å®¢åŒºã€‚', more:''},
  {n:3,  t:'é¢„çº¦ï¼šç±³å¥‡å¦™æ¸¸ç«¥è¯ä¹¦', must:true,  tip:'APP é¢„çº¦ç­‰å€™å¡ï¼›å³ä¾§æ’é˜Ÿï¼›ä¸€æ¥¼é˜¶æ¢¯ä¸­åæ’ã€‚', more:'ç•™æ„åœºæ¬¡ 16:25 / 17:30ã€‚'},
  {n:4,  t:'ä¸ƒä¸ªå°çŸ®äººçŸ¿å±±è½¦',   must:true,  tip:'ä¼˜é€‰æœ€åä¸€æ’ï¼Œæ‘†åŠ¨æ„Ÿæ›´å¼ºã€‚', more:'æ¢¦å¹»ä¸–ç•Œ Â· å®¶åº­è¿‡å±±è½¦ã€‚'},
  {n:5,  t:'ç–¯ç‹‚åŠ¨ç‰©åŸï¼šçƒ­åŠ›è¿½è¸ª', must:true,  tip:'çŸ¿è½¦ä¸œä¾§å…¥å£ï¼›æ’å³è¾¹é˜Ÿä¼ï¼›å°½é‡åç¬¬äºŒè¾†è½¦/å‰æ’ã€‚', more:'æ‰“å¡åæ—è¾¹ç›–ç« ï¼ˆåŠ¨ç‰©åŸè­¦å±€æ‹›å‹Ÿä¸­å¿ƒï¼‰ã€‚'},
  {n:6,  t:'é£è·ƒåœ°å¹³çº¿',         must:true,  tip:'å·¦ä¾§é˜Ÿä¼ï¼›2 å·é—¨å…¥ 1 å·é€šé“ã€‚', more:'å»ºè®®å…ˆæ”¾åŒ…ï¼Œä¸“å¿ƒè§‚æ™¯ã€‚'},
  {n:7,  t:'åŠ å‹’æ¯”æµ·ç›—ï¼šæ²‰è½å®è—ä¹‹æˆ˜', must:true,  tip:'æœ€å·¦é€šé“ï¼›æ—©æ™šäººå°‘ï¼›ä¼˜å…ˆç¬¬ä¸€æ’ã€‚', more:'å‡ºåœºåä¾æ¬¡å¯ç›–ç« ï¼šèˆ¹å¥‡æˆæ°´æ»©å·¦ä¾§æ ‘æœ¨ â†’ ï¼ˆé›·é¸£å±±æ¼‚æµå¯é€‰ï¼‰â†’ å¤è¿¹æ¢ç´¢è¥å…¥å£ â†’ å¥‡å¥‡è’‚è’‚æ·˜æ·˜é“ºã€‚'},
  {n:8,  t:'åˆ›æé€Ÿå…‰è½®',         must:true,  tip:'å¤–åœºç›–ç« ï¼›è‹¥æ’é•¿é˜Ÿå¯æ”¹å‚æ™šã€‚', more:'é€Ÿåº¦åˆºæ¿€ï¼Œå¯ä¼˜å…ˆå®‰æ’ã€‚'},
  {n:9,  t:'å·´æ–¯å…‰å¹´æ˜Ÿé™…è¥æ•‘ï¼ˆå¯é€‰ï¼‰', must:false, tip:'æ—è¾¹å¯ç›–ç« ï¼›æ¥å¯é€‰ï¼šå¤ªç©ºå¯¹è¯å²è¿ªå¥‡ â†’ å–·æ°”èƒŒåŒ…é£è¡Œå™¨ã€‚', more:'å¾—åˆ†å‘ç©æ³•ï¼Œå®¶åº­å‹å¥½ã€‚'},
  {n:10, t:'èŠ±è½¦å·¡æ¸¸',           must:true,  tip:'æå‰ 20 åˆ†é’Ÿå ä½ã€‚', more:''},
  {n:11, t:'æŠ±æŠ±é¾™å†²å¤©èµ›è½¦',     must:true,  tip:'åæ’å¤±é‡æ„Ÿæ›´å¼ºã€‚', more:'ç›–ç« ï¼šè‰¾å°”ç©å…·åº—ï¼ˆé—¨å£ï¼‰ï¼›å¯é€‰ï¼šå¼¹ç°§ç‹—å›¢å›¢è½¬ï¼›èƒ¡è¿ªç‰›ä»”å˜‰å¹´åæ‰¾â€œå¼€å£ç¬‘çš„é©´â€ã€‚'},
  {n:12, t:'æ¢¦å¹»ä¸–ç•Œè¡¥ç¥¨ï¼ˆå¯é€‰ï¼‰', must:false, tip:'å°é£ä¾ å¤©ç©ºå¥‡é‡ â†’ æ™¶å½©å¥‡èˆªã€‚', more:'åº—å†…ç›–ç« ï¼šç±³å¥‡ç±³å¦®åŒå¿ƒé“ºï¼›åŸå ¡å¤–ä¾§ç›–ç« ï¼›å†°é›ªå¥‡ç¼˜æ’å·¦è¾¹åå·¦è¿‡é“ã€‚'},
  {n:13, t:'ç™¾äº©æ£®æ—æ®µ',         must:true,  tip:'æ—‹è½¬ç–¯èœœç½ â†’ å°ç†Šç»´å°¼å†é™©è®°ã€‚', more:'ç›–ç« ï¼šæ£®æ—ç™¾ç‰©å•†åº—æ”¶é“¶é™„è¿‘ï¼›é€”ä¸­å¯åœ¨é­”æ³•å¸ˆç§˜åˆ¶å°é£Ÿè¡¥ç»™ã€‚'},
  {n:14, t:'åŠ¨ç‰©åŸæ‹ç…§ & çˆªå­å†°æ£', must:true, tip:'åˆ©ç”¨ä¸‹åˆä½å³°è¡¥ç…§ç‰‡ã€‚', more:''},
  {n:15, t:'çˆ±ä¸½ä¸è¿·å®« + æ¼«æ¸¸ç«¥è¯æ—¶å…‰', must:true, tip:'è¿·å®«å‡ºå£ç›–ç«  â†’ è¿›åŸå ¡æ¼«æ¸¸ã€‚', more:''},
  {n:16, t:'ç±³å¥‡å¦™æ¸¸ç«¥è¯ä¹¦ï¼ˆæ¼”å‡ºï¼‰', must:true, tip:'16:25 / 17:30 åœºï¼›æ­é…å¥‡æƒ³èŠ±å›­è§é¢ä¼šï¼›ç›–ç« ï¼šæ¼«å¨è‹±é›„æ€»éƒ¨é’¢é“ä¾ æ—ã€‚', more:''},
  {n:17, t:'åŸå ¡é™„è¿‘è½¬ä¸€åœˆï¼ˆå¯é€‰ï¼‰', must:false, tip:'å°é£è±¡ + æ—‹è½¬æœ¨é©¬ â†’ åäºŒæœ‹å‹å›­é ç‹—ç‹—å£ç”»ç›–ç« ã€‚', more:''},
  {n:18, t:'ç±³å¥‡å¥½ä¼™ä¼´ç¾å‘³é›†å¸‚ï¼ˆæ™šé¤ï¼‰', must:true, tip:'è¡¥èƒ½é‡ï¼Œä¸ºçƒŸèŠ±åšå‡†å¤‡ã€‚', more:''},
  {n:19, t:'M å¤§è¡— & è€è½¦ç«™ & ç«¥è½¦ç§Ÿèµç›–ç« ', must:true, tip:'ä¾æ¬¡å®Œæˆï¼šè€è½¦ç«™å•†åº— â†’ M å¤§è¡—è´­ç‰©å»Š â†’ ç«¥è½¦/è½®æ¤…ç§Ÿèµå¤„ã€‚', more:''},
  {n:20, t:'21:15 å¥‡æ¢¦ä¹‹å…‰å¹»å½±ç§€',  must:true, tip:'æå‰ 30 åˆ†é’Ÿå ä½ï¼›ç•™æ„é£å‘é¿çƒŸèŠ±ç°ã€‚', more:''},
];
(function(){
  const box = $('#timeline');
  const create = (s)=>{
    const el = document.createElement('section');
    el.className = 'step'+(load('step.open.'+s.n,false)?' open':'');
    el.dataset.must = s.must ? '1':'0';
    el.dataset.title = (s.t + ' ' + s.tip + ' ' + s.more).toLowerCase();
    el.innerHTML = `
      <div class="step-head" role="button" aria-expanded="${el.classList.contains('open')}" tabindex="0">
        <div class="step-num">${s.n}</div>
        <div class="step-title">${s.t}</div>
        <div class="step-tags">
          ${s.must?'<span class="chip ok">å¿…ç©</span>':'<span class="chip">å¯é€‰</span>'}
          ${(/ç›–ç« |ç›– ç« /.test(s.tip+s.more))?'<span class="stamp">ç›–ç« ç‚¹</span>':''}
        </div>
      </div>
      <div class="step-body"><div class="detail">${s.tip}</div>${s.more?`<div class="muted" style="margin-top:6px">${s.more}</div>`:''}</div>
    `;
    const head = el.querySelector('.step-head');
    head.addEventListener('click',()=>{
      el.classList.toggle('open'); save('step.open.'+s.n, el.classList.contains('open'))
      head.setAttribute('aria-expanded', el.classList.contains('open'))
    });
    head.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' ') head.click(); });
    return el;
  }
  STEPS.forEach(s => box.appendChild(create(s)));

  // è¿‡æ»¤æ ‡ç­¾
  $('#filters').addEventListener('click', e=>{
    const b = e.target.closest('.tab'); if(!b) return;
    $$('#filters .tab').forEach(t=>t.classList.remove('active'));
    b.classList.add('active');
    const mode = b.dataset.filter;
    $$('#timeline .step').forEach(el=>{
      const isMust = el.dataset.must==='1';
      let show = true;
      if(mode==='must') show = isMust;
      if(mode==='opt')  show = !isMust;
      el.style.display = show?'':'none';
    })
  })
  // å…³é”®è¯è¿‡æ»¤
  $('#search').addEventListener('input', e=>{
    const kw = e.target.value.trim().toLowerCase();
    $$('#timeline .step').forEach(el=>{
      const ok = !kw || el.dataset.title.includes(kw);
      el.style.display = ok? '': 'none';
    })
  })
})();

// ====== åœ°å›¾ï¼ˆLeafletï¼‰ ======
const MAP_POINTS = [
  {name:'ä¸Šæµ·è¿ªå£«å°¼ä¹å›­ï¼ˆä¸­å¿ƒï¼‰',  lat:31.1440,    lng:121.6570,   note:'å›­åŒºä¸­å¿ƒ Â· é€‚åˆä½œä¸ºå¯¼èˆªç‚¹'},
  {name:'åœ°é“ 11 å·çº¿ Â· è¿ªå£«å°¼ç«™', lat:31.143429, lng:121.663737, note:'æ˜Ÿæ„¿æ¹–åŒ—ä¾§ï¼Œå‡ºç«™æ­¥è¡Œå…¥å›­'},
  {name:'é£è·ƒåœ°å¹³çº¿ï¼ˆæ¢é™©å²›ï¼‰',   lat:31.1441416, lng:121.664791, note:'å»ºè®®å·¦ä¾§é˜Ÿä¼ Â· 2å·é—¨å…¥ 1å·é€šé“'},
  {name:'ä¸ƒä¸ªå°çŸ®äººçŸ¿å±±è½¦',       lat:31.145539,  lng:121.660329, note:'æ¢¦å¹»ä¸–ç•Œ Â· å®¶åº­è¿‡å±±è½¦'},
  {name:'åˆ›æé€Ÿå…‰è½®ï¼ˆæ˜æ—¥ä¸–ç•Œï¼‰', lat:31.1437278, lng:121.6525528, note:'é€Ÿåº¦åˆºæ¿€ Â· å¤–ä¾§å¯ç›–ç« '}
];
(function(){
  let mapOK = true;
  try{
    const map = L.map('map',{scrollWheelZoom:true,zoomControl:true}).setView([31.1440,121.6570], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);
    MAP_POINTS.forEach(p=>{
      const marker = L.marker([p.lat,p.lng]).addTo(map);
      marker.bindPopup(`<b>${p.name}</b><br>${p.note}`);
    });
  }catch(e){
    mapOK = false; console.warn('åœ°å›¾åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½å›¾', e);
  }
  if(!mapOK){
    document.getElementById('map').style.display='none';
    document.getElementById('mapFallback').style.display='block';
  }
})();

// ====== åº•éƒ¨æŒ‰é’® ======
$('#btnExpand').addEventListener('click',()=> $$('#timeline .step').forEach(el=>{el.classList.add('open'); save('step.open.'+el.querySelector('.step-num').textContent,true)}));
$('#btnCollapse').addEventListener('click',()=> $$('#timeline .step').forEach(el=>{el.classList.remove('open'); save('step.open.'+el.querySelector('.step-num').textContent,false)}));
$('#btnReset').addEventListener('click',()=>{
  if(!confirm('æ¸…ç©ºæ‰€æœ‰å‹¾é€‰ä¸å±•å¼€çŠ¶æ€ï¼Ÿ')) return;
  Object.keys(localStorage).filter(k=>k.startsWith(KEY_PREFIX)).forEach(k=>localStorage.removeItem(k));
  location.reload();
});
$('#btnExport').addEventListener('click',()=>{
  const data = {
    time: new Date().toISOString(),
    packing: PACK_ITEMS.map((n,i)=>({name:n, done: load('pack.'+i,false)})),
    stamps : STAMPS.map((n,i)=>({name:n, done: load('stamp.'+i,false)})),
    steps  : STEPS.map(s=>({n:s.n, title:s.t, open: load('step.open.'+s.n,false)}))
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'),{href:url, download:'è¿ªå£«å°¼æ”»ç•¥è¿›åº¦-'+Date.now()+'.json'});
  a.click(); URL.revokeObjectURL(url);
});

// åˆå§‹åŒ–å‹¾é€‰æŒä¹…åŒ–
persistChecks(document);
</script>
</body>
</html>
